package alg;

import java.util.ArrayList;

public class BountyAlgorithm {
	private Bounty[][] startingBounties;
	private ArrayGrid<Integer> inputGrid;
	private int tileCount;
	private int xSize;
	private int ySize;
	
	private ArrayGrid<ArrayList<Bounty>[]> bountyGrid;
	
	public BountyAlgorithm(Bounty[][] startingBounties, ArrayGrid<Integer> inputGrid, int tileCount) {
		run(startingBounties, inputGrid, tileCount);
	}
	
	private void addNextBounty(Bounty bounty, int x, int y) {		
		if(!bounty.hasNext()) {
			System.out.println("Matched at " + x + ", " + y);
			return;
		}
		
		Bounty nextBounty = bounty.getNext();
		
		int indexX = x + bounty.offsetX();
		int indexY = y + bounty.offsetY();
		
		if(!bountyGrid.inBounds(indexX, indexY))
			return;
		
		ArrayList<Bounty> bountyArr = bountyGrid.getSet(indexX, indexY, new ArrayList[tileCount])[nextBounty.value()];
		
		if(bountyArr == null) {
			bountyArr = new ArrayList[tileCount];
			bountyGrid.set(indexX,  indexY, bountyArr);
		}
		
		ArrayList<Bounty> targetBounties = bountyArr[nextBounty.value()];
		
		if(targetBounties == null) {
			targetBounties = new ArrayList<Bounty>();
			bountyArr[nextBounty.value()] = targetBounties;
		}
		
		targetBounties.add(nextBounty);
		//System.out.println("Put "+nextBounty.value+" at "+indexX+","+indexY);
	}
	
	private boolean bountyMatch(int currentCell, int x, int y) {
		ArrayList<Bounty>[] targetBounties = bountyGrid.get(x,  y);
		
		if(targetBounties != null && targetBounties[currentCell] != null) {
			return true;
		}
		
		if(startingBounties[currentCell] != null)
			return true;
		
		return false;
	}
	
	private void addNextBountiesAll(int matchCell, int x, int y) {
		ArrayList<Bounty>[] sourceBounties = bountyGrid.get(x,  y);
		
		if(sourceBounties != null && sourceBounties[matchCell] != null) {
			for(Bounty el : sourceBounties[matchCell]) {
				addNextBounty(el, x, y);
			}
		}
		
		Bounty[] sourceStarters = startingBounties[matchCell];
		
		if(sourceStarters != null) {
			for(Bounty el : sourceStarters) {
				addNextBounty(el, x, y);
			}
		}
	}
	
	public void run(Bounty[][] startingBounties, ArrayGrid<Integer> inputGrid, int tileCount) {
		this.startingBounties = startingBounties;
		this.inputGrid = inputGrid;
		this.tileCount = tileCount;
		xSize = inputGrid.xSize();
		ySize = inputGrid.ySize();
		
		bountyGrid = new ArrayGrid<>(xSize, ySize);
		
		for(int y = 0; y < ySize; y++) {
			for(int x = 0; x < xSize; x++) {
				int currentCell = inputGrid.get(x, y);
				if(bountyMatch(currentCell, x, y))
					addNextBountiesAll(currentCell, x, y);
			}
		}
	}
}
